<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Diagnostica Canvas — Deve Vedersi</title>
<style>
  html,body{margin:0;height:100%;background:#0b1224;color:#e5e7eb;font:14px system-ui}
  #wrap{max-width:980px;margin:16px auto;padding:10px;border:1px solid #1f2a44;border-radius:12px;background:#0f172a}
  canvas{display:block;width:100%;height:auto;border-radius:10px;border:1px solid #1f2a44;background:#0b1224;image-rendering:pixelated}
  .bar{margin:8px 0;color:#a1a1aa}
  #status{position:fixed;left:8px;top:8px;background:#111827;border:1px solid #1f2a44;border-radius:8px;padding:6px 10px}
  .btn{background:#7c3aed;border:0;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
</style>
</head>
<body>
<div id="status">boot: ok — se non vedi la scacchiera verde/azzurra c’è un blocco JS/CSS</div>
<div id="wrap">
  <p class="bar">Clicca sulla mappa per muovere il quadrato BLU (player). Il ROSSO è un “mob”. Il GIALLO sono monete.</p>
  <button class="btn" onclick="startGame()">Avvia</button>
  <canvas id="cv" width="960" height="600"></canvas>
</div>

<script>
(function(){
  const cv=document.getElementById('cv');
  const ctx=cv.getContext('2d');
  let started=false;

  // mappa isometrico-like (rombi disegnati come griglia diagonale semplificata)
  const COLS=12, ROWS=9, TW=80, TH=40;
  const offX=cv.width/2, offY=120;

  const player={x:2,y:2};
  const mobs=[{x:6,y:4},{x:9,y:2}];
  const coins=[{x:3,y:6},{x:7,y:1},{x:10,y:7}];

  function isoToScreen(ix,iy){
    return {x:(ix-iy)*(TW/2)+offX, y:(ix+iy)*(TH/2)+offY};
  }

  function drawTile(x,y){
    const s=isoToScreen(x,y);
    ctx.beginPath();
    ctx.moveTo(s.x, s.y-TH/2);
    ctx.lineTo(s.x+TW/2, s.y);
    ctx.lineTo(s.x, s.y+TH/2);
    ctx.lineTo(s.x-TW/2, s.y);
    ctx.closePath();
    ctx.fillStyle = ((x+y)%2===0)? '#14532d' : '#166534'; // verde alternato
    ctx.fill();
    ctx.strokeStyle='#0b3a23';
    ctx.stroke();
  }

  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);
    // sfondo check evidente
    ctx.fillStyle='#0a1226'; ctx.fillRect(0,0,cv.width,cv.height);
    // tiles
    for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) drawTile(x,y);

    // coins (giallo)
    for(const c of coins){
      const s=isoToScreen(c.x,c.y);
      ctx.fillStyle='#facc15';
      ctx.beginPath(); ctx.arc(s.x, s.y-12, 10, 0, Math.PI*2); ctx.fill();
    }
    // mobs (rosso)
    for(const m of mobs){
      const s=isoToScreen(m.x,m.y);
      ctx.fillStyle='#ef4444';
      ctx.fillRect(s.x-14, s.y-46, 28, 36);
      // ombra
      ctx.fillStyle='#0006';
      ctx.beginPath(); ctx.ellipse(s.x, s.y-6, 20, 6, 0, 0, Math.PI*2); ctx.fill();
    }
    // player (blu)
    {
      const s=isoToScreen(player.x,player.y);
      ctx.fillStyle='#3b82f6';
      ctx.fillRect(s.x-14, s.y-46, 28, 36);
      ctx.fillStyle='#0006';
      ctx.beginPath(); ctx.ellipse(s.x, s.y-6, 20, 6, 0, 0, Math.PI*2); ctx.fill();
    }

    // testo gigante per essere sicuri si veda qualcosa
    ctx.fillStyle='#e5e7eb';
    ctx.font='bold 18px system-ui';
    ctx.fillText('DIAGNOSTICA: se vedi verde/rosso/blu, il canvas funziona.', 20, cv.height-20);
  }

  function screenToIso(sx,sy){
    const x = ((sx - offX)/(TW/2) + (sy - offY)/(TH/2))/2;
    const y = ((sy - offY)/(TH/2) - (sx - offX)/(TW/2))/2;
    return {x, y};
  }

  function handleClick(ev){
    if(!started) return;
    const r=cv.getBoundingClientRect();
    const sx=(ev.clientX-r.left)*(cv.width/r.width);
    const sy=(ev.clientY-r.top)*(cv.height/r.height);
    const iso=screenToIso(sx,sy);
    player.x = Math.max(0, Math.min(COLS-1, Math.round(iso.x)));
    player.y = Math.max(0, Math.min(ROWS-1, Math.round(iso.y)));
    draw();
  }

  cv.addEventListener('click', handleClick);

  window.startGame = function(){
    started=true;
    document.getElementById('status').textContent='running: OK — click per muovere il quadrato BLU';
    draw();
  };

  // draw una volta “spento”
  draw();

  // Diagnostica base
  try{
    document.getElementById('status').textContent='boot: pronto — premi Avvia. Se non vedi nulla, JS bloccato.';
  }catch(e){}
})();
</script>
</body>
</html>
